{% raw %}{% include './common.j2' %}{% endraw %}
fs:
  # root
  "/":
    readdir: 
      sh: ls /accounts
    getattr:
      sh: *dir 
      # /<id>
    "/[0-9]+":
      name: id
      readdir: 
        list: 
        - ec2
      getattr: 
          sh: *dir
      # /<id>/.init.lua
      "/.init.lua":
        getattr:
          sh: *file
        read_file: 
          sh: |
            cat <<EOF
{% filter indent(15, first=True) -%}
                  {% include '.init.lua'%}
                  {%- endfilter %}       
            EOF
            
      # /<id>/n/cmdchan/chan/cmd
      "/n":
        getattr:
          sh: *dir
        "/cmdchan":
          getattr: 
            sh: *dir
          "/cmdchan_output":
            getattr: 
              sh: *file
            read_file:
              sh: cat /accounts/$id/out
          "/chan":
            getattr: 
              sh: *dir
            "/cmd":
              getattr: 
                sh: *file
              write_file:
                sh: |
                    str=`cat $CACHE_FILE_NAME`
                    rm -f /accounts/$id/out
                    eval "aws $str --profile $id" > /accounts/$id/out 2>&1
      # /<id>/ec2
      "/ec2":
        readdir:
          list: 
          - describe-instances
        getattr:
          sh: *dir
          # /<id>/ec2/describe-instances
        "/describe-instances":
          cache: 360
          readdir:
            sh: aws ec2 describe-instances --profile $id  | jq -r '.Reservations[].Instances[].InstanceId'
          getattr:
            sh: *dir 
          # /<id>/ec2/describe-instances/<instance>
          "/[a-z0-9_-]+":
            name: instanceid
            cache: 16000
            getattr: 
              sh: *dir 
            readdir: 
              sh: aws ec2 describe-instances --profile $id  | jq -r ".Reservations[].Instances[] | select (.InstanceId==\"$instanceid\")" | jq -r "keys[]"
            # /<id>/ec2/describe-instances/<instance>/<parameter>
            "/[a-zA-Z0-9_-]+":
              name: parameter
              getattr:
                sh: *file
              read_file:
                sh: aws ec2 describe-instances --profile $id  | jq -r ".Reservations[].Instances[] | select (.InstanceId==\"$instanceid\") .\"$parameter\""
